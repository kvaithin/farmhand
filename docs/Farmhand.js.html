<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Farmhand.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module.html#.exports">exports</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleAddMoneyClick">handleAddMoneyClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleClickDialogViewButton">handleClickDialogViewButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleClickLoanPaydownButton">handleClickLoanPaydownButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleClickTakeOutLoanButton">handleClickTakeOutLoanButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleCombinePurchase">handleCombinePurchase</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleCowAutomaticHugChange">handleCowAutomaticHugChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleCowBreedChange">handleCowBreedChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleCowClick">handleCowClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleCowHugClick">handleCowHugClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleCowNameInputChange">handleCowNameInputChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleCowOfferClick">handleCowOfferClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleCowPenPurchase">handleCowPenPurchase</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleCowPurchaseClick">handleCowPurchaseClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleCowSelect">handleCowSelect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleCowSellClick">handleCowSellClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleCowTradeClick">handleCowTradeClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleCowWithdrawClick">handleCowWithdrawClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleFarmNameUpdate">handleFarmNameUpdate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleFieldActionRangeChange">handleFieldActionRangeChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleFieldModeSelect">handleFieldModeSelect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleFieldPurchase">handleFieldPurchase</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleImportDataClick">handleImportDataClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleItemPurchaseClick">handleItemPurchaseClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleItemSelectClick">handleItemSelectClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleItemSellClick">handleItemSellClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleMakeRecipeClick">handleMakeRecipeClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleMenuToggle">handleMenuToggle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handlePlotClick">handlePlotClick</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleSmelterPurchase">handleSmelterPurchase</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleUpgradeTool">handleUpgradeTool</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleViewChange">handleViewChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module.html#.exports#.handleViewChangeButtonClick">handleViewChangeButtonClick</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="module.html#.exports#_factoryInstances">_factoryInstances</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="module.html#.exports#_instance">_instance</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="module.html#.exports#getFactoryForItemType">getFactoryForItemType</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="farmhand.module_items.html">items</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_items.html#.chocolateMilk">chocolateMilk</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_items.html#.cowFeed">cowFeed</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_items.html#.fertilizer">fertilizer</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_items.html#.huggingMachine">huggingMachine</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_items.html#.milk1">milk1</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_items.html#.milk2">milk2</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_items.html#.milk3">milk3</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_items.html#.rainbowFertilizer">rainbowFertilizer</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_items.html#.rainbowMilk1">rainbowMilk1</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_items.html#.rainbowMilk2">rainbowMilk2</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_items.html#.rainbowMilk3">rainbowMilk3</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_items.html#.scarecrow">scarecrow</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_items.html#.sprinkler">sprinkler</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html">recipes</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.bread">bread</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.bronzeIngot">bronzeIngot</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.burger">burger</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.butter">butter</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.carrotSoup">carrotSoup</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.cheese">cheese</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.chocolate">chocolate</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.chocolateSoyMilk">chocolateSoyMilk</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.frenchOnionSoup">frenchOnionSoup</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.goldIngot">goldIngot</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.hotSauce">hotSauce</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.ironIngot">ironIngot</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.jackolantern">jackolantern</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.popcorn">popcorn</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.rainbowCheese">rainbowCheese</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.salsa">salsa</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.silverIngot">silverIngot</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.soyMilk">soyMilk</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.spaghetti">spaghetti</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.spicyCheese">spicyCheese</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.strawberryJam">strawberryJam</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.summerSalad">summerSalad</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="farmhand.module_recipes.html#.tofu">tofu</a></span></li><li class="nav-heading">Namespaces</li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="farmhand.html">farmhand</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#applyPriceEvents">applyPriceEvents</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#asparagus">asparagus</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#asparagusSeed">asparagusSeed</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#bronzeOre">bronzeOre</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#carrot">carrot</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#carrotSeed">carrotSeed</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#categorizeShopInventory">categorizeShopInventory</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#coal">coal</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#corn">corn</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#cornSeed">cornSeed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createInitialState">createInitialState</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#farmhandStub">farmhandStub</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#generate">generate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#generateFactoryInstance">generateFactoryInstance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#generateResources">generateResources</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#generateValueAdjustments">generateValueAdjustments</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getLearnedRecipeCategories">getLearnedRecipeCategories</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getUpgradesAvailable">getUpgradesAvailable</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#goldOre">goldOre</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#handleCowTradeRequest">handleCowTradeRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#handleCowTradeRequestAccept">handleCowTradeRequestAccept</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#handleCowTradeRequestReject">handleCowTradeRequestReject</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#handlePeerMetadataRequest">handlePeerMetadataRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#instance">instance</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#ironOre">ironOre</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#jalapeno">jalapeno</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#jalapenoSeed">jalapenoSeed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#messagePeers">messagePeers</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onion">onion</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#onionSeed">onionSeed</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#pea">pea</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#peaSeed">peaSeed</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#potato">potato</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#potatoSeed">potatoSeed</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#pumpkin">pumpkin</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#pumpkinSeed">pumpkinSeed</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#silverOre">silverOre</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#soybean">soybean</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#soybeanSeed">soybeanSeed</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#spinach">spinach</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#spinachSeed">spinachSeed</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#stone">stone</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#strawberry">strawberry</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#strawberrySeed">strawberrySeed</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#testShoveledPlot">testShoveledPlot</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#tomato">tomato</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#tomatoSeed">tomatoSeed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#tradeForPeerCow">tradeForPeerCow</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#upgrades">upgrades</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#watermelon">watermelon</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#watermelonSeed">watermelonSeed</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#wheat">wheat</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#wheatSeed">wheatSeed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#wrapSendPeerMetadata">wrapSendPeerMetadata</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">Farmhand.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, { Component } from 'react'
import window from 'global/window'
import { Redirect } from 'react-router-dom'
import { GlobalHotKeys } from 'react-hotkeys'
import localforage from 'localforage'
import { v4 as uuid } from 'uuid'
import { MuiThemeProvider } from '@material-ui/core/styles'
import Drawer from '@material-ui/core/Drawer'
import Fab from '@material-ui/core/Fab'
import MenuIcon from '@material-ui/icons/Menu'
import HotelIcon from '@material-ui/icons/Hotel'
import KeyboardArrowLeft from '@material-ui/icons/KeyboardArrowLeft'
import KeyboardArrowRight from '@material-ui/icons/KeyboardArrowRight'
import Tooltip from '@material-ui/core/Tooltip'
import MobileStepper from '@material-ui/core/MobileStepper'
import { joinRoom } from 'trystero'
import { SnackbarProvider } from 'notistack'
import debounce from 'lodash.debounce'
import throttle from 'lodash.throttle'
import classNames from 'classnames'
import { object } from 'prop-types'

import FarmhandContext from './Farmhand.context'
import eventHandlers from './handlers/ui-events'
import {
  handlePeerMetadataRequest,
  handleCowTradeRequest,
  handleCowTradeRequestAccept,
  handleCowTradeRequestReject,
} from './handlers/peer-events'
import * as reducers from './game-logic/reducers'
// This must be imported here so that it can be overridden by component styles.
import './Farmhand.sass'

import AppBar from './components/AppBar'
import Navigation from './components/Navigation'
import ContextPane from './components/ContextPane'
import Stage from './components/Stage'
import NotificationSystem, {
  snackbarProviderContentCallback,
} from './components/NotificationSystem'
import DebugMenu from './components/DebugMenu'
import theme from './mui-theme'
import {
  computeMarketPositions,
  createNewField,
  doesMenuObstructStage,
  farmProductsSold,
  getAvailableShopInventory,
  getItemCurrentValue,
  getLevelEntitlements,
  getPeerMetadata,
  inventorySpaceRemaining,
  levelAchieved,
  memoize,
  moneyTotal,
  nullArray,
  reduceByPersistedKeys,
  sleep,
  transformStateDataForImport,
} from './utils'
import { getData, postData } from './fetch-utils'
import { itemsMap, recipesMap } from './data/maps'
import {
  dialogView,
  fieldMode,
  stageFocusType,
  toolLevel,
  toolType,
} from './enums'
import {
  COW_TRADE_TIMEOUT,
  DEFAULT_ROOM,
  INITIAL_STORAGE_LIMIT,
  PURCHASEABLE_COW_PENS,
  STAGE_TITLE_MAP,
  STANDARD_LOAN_AMOUNT,
} from './constants'
import { HEARTBEAT_INTERVAL_PERIOD, SERVER_ERRORS } from './common/constants'
import {
  CONNECTED_TO_ROOM,
  COW_PEN_PURCHASED,
  LOAN_INCREASED,
  POSITIONS_POSTED_NOTIFICATION,
  RECIPE_LEARNED,
  RECIPES_LEARNED,
  ROOM_FULL_NOTIFICATION,
} from './templates'
import {
  CONNECTING_TO_SERVER,
  COW_ALREADY_OWNED,
  DATA_DELETED,
  DISCONNECTED_FROM_SERVER,
  INVENTORY_FULL_NOTIFICATION,
  PROGRESS_SAVED_MESSAGE,
  REQUESTED_COW_TRADE_UNAVAILABLE,
  SERVER_ERROR,
  UPDATE_AVAILABLE,
} from './strings'
import { endpoints } from './config'

const { CLEANUP, HARVEST, MINE, OBSERVE, WATER } = fieldMode

const itemIds = Object.freeze(Object.keys(itemsMap))

// Utility object for reuse in no-ops to save on memory
const emptyObject = Object.freeze({})

/*!
 * @param {Array.&lt;{ id: farmhand.item, quantity: number }>} inventory
 * @param {Object.&lt;number>} valueAdjustments
 * @returns {Array.&lt;farmhand.item>}
 */
export const computePlayerInventory = memoize((inventory, valueAdjustments) =>
  inventory.map(({ quantity, id }) => ({
    quantity,
    ...itemsMap[id],
    value: getItemCurrentValue(itemsMap[id], valueAdjustments),
  }))
)

/*!
 * @param {Array.&lt;{ id: farmhand.item }>} inventory
 * @returns {Array.&lt;{ id: farmhand.item }>}
 */
export const getFieldToolInventory = memoize(inventory =>
  inventory
    .filter(({ id }) => {
      const { enablesFieldMode } = itemsMap[id]

      return (
        typeof enablesFieldMode === 'string' &amp;&amp;
        enablesFieldMode !== fieldMode.PLANT
      )
    })
    .map(({ id }) => itemsMap[id])
)

/*!
 * @param {Array.&lt;{ id: farmhand.item }>} inventory
 * @returns {Array.&lt;{ id: farmhand.item }>}
 */
export const getPlantableCropInventory = memoize(inventory =>
  inventory
    .filter(({ id }) => itemsMap[id].isPlantableCrop)
    .map(({ id }) => itemsMap[id])
)

/**
 * @param {Object.&lt;number>} valueAdjustments
 * @param {farmhand.priceEvent} priceCrashes
 * @param {farmhand.priceEvent} priceSurges
 * @returns {Object.&lt;number>}
 */
const applyPriceEvents = (valueAdjustments, priceCrashes, priceSurges) => {
  const patchedValueAdjustments = { ...valueAdjustments }

  Object.keys(priceCrashes).forEach(itemId => {
    patchedValueAdjustments[itemId] = 0.5
  })
  Object.keys(priceSurges).forEach(itemId => {
    patchedValueAdjustments[itemId] = 1.5
  })

  return patchedValueAdjustments
}

/**
 * @typedef farmhand.state
 * @type {Object}
 * @property {number?} activePlayers
 * @property {boolean} allowCustomPeerCowNames
 * @property {farmhand.module:enums.dialogView} currentDialogView
 * @property {Object.&lt;string, boolean>} completedAchievements Keys are
 * achievement ids.
 * @property {farmhand.cow} cowForSale
 * @property {farmhand.cowBreedingPen} cowBreedingPen
 * @property {Array.&lt;farmhand.cow>} cowInventory
 * @property {Object.&lt;farmhand.module:enums.cowColors, number>}
 * cowColorsPurchased Keys are color enums, values are the number of that color
 * of cow purchased.
 * @property {string} cowIdOfferedForTrade The ID of the cow that is currently
 * set to be traded with online peers.
 * @property {Object} cowsSold Keys are items IDs, values are the id references
 * of cow colors (rainbow-cow, etc.).
 * @property {number} cowsTraded
 * @property {number?} cowTradeTimeoutId
 * @property {Object.&lt;farmhand.module:enums.cropType, number>} cropsHarvested A
 * map of totals of crops harvested. Keys are crop type IDs, values are the
 * number of that crop harvested.
 * @property {number} dayCount
 * @property {Array.&lt;Array.&lt;?farmhand.plotContent>>} field
 * @property {farmhand.module:enums.fieldMode} fieldMode
 * @property {Function?} getCowAccept https://github.com/dmotz/trystero#receiver
 * @property {Function?} getCowReject https://github.com/dmotz/trystero#receiver
 * @property {Function?} getCowTradeRequest https://github.com/dmotz/trystero#receiver
 * @property {Function?} getPeerMetadata https://github.com/dmotz/trystero#receiver
 * @property {number?} heartbeatTimeoutId
 * @property {Array.&lt;number>} historicalDailyLosses
 * @property {Array.&lt;number>} historicalDailyRevenue
 * @property {Array.&lt;Object.&lt;number>>} historicalValueAdjustments Currently
 * there is only one element in this array, but it will be used for more
 * historical price data analysis in the future. It is an array for
 * future-facing flexibility.
 * @property {number} hoveredPlotRangeSize
 * @property {string} id
 * @property {Array.&lt;{ id: farmhand.item, quantity: number }>} inventory
 * @property {number} inventoryLimit Is -1 if inventory is unlimited.
 * @property {boolean} isAwaitingCowTradeRequest
 * @property {boolean} isAwaitingNetworkRequest
 * @property {boolean} isCombineEnabled
 * @property {boolean} isMenuOpen
 * @property {Object} itemsSold Keys are items IDs, values are the number of
 * that item sold.
 * @property {boolean} isDialogViewOpen
 * @property {boolean} isOnline Whether the player is playing online.
 * @property {boolean} isWaitingForDayToCompleteIncrementing
 * @property {Object} learnedRecipes Keys are recipe IDs, values are `true`.
 * @property {number} loanBalance
 * @property {number} loansTakenOut
 * @property {number} money
 * @property {farmhand.notification} latestNotification
 * @property {Array.&lt;farmhand.notification>} newDayNotifications
 * @property {Array.&lt;farmhand.notification>} notificationLog
 * @property {Object} peers Keys are (Trystero) peer ids, values are their respective metadata or null.
 * @property {Object?} peerRoom See https://github.com/dmotz/trystero
 * @property {Array.&lt;farmhand.peerMessage>} pendingPeerMessages An array of
 * messages to be sent to the Trystero peer room upon the next broadcast.
 * @property {Array.&lt;farmhand.peerMessage>} latestPeerMessages An array of
 * messages that have been received from peers.
 * @property {function?} sendPeerMetadata See https://github.com/dmotz/trystero
 * @property {string} selectedCowId
 * @property {string} selectedItemId
 * @property {Object.&lt;string, farmhand.priceEvent>} priceCrashes Keys are
 * itemIds.
 * @property {Object.&lt;string, farmhand.priceEvent>} priceSurges Keys are
 * itemIds.
 * @property {number} purchasedCombine
 * @property {number} purchasedCowPen
 * @property {number} purchasedField
 * @property {number} profitabilityStreak
 * @property {number} record7dayProfitAverage
 * @property {number} recordProfitabilityStreak
 * @property {number} recordSingleDayProfit
 * @property {number} revenue The amount of money the player has generated in
 * @property {string} redirect Transient value used to drive router redirection.
 * @property {string} room What online room the player is in.
 * @property {Function?} sendCowAccept https://github.com/dmotz/trystero#sender
 * @property {Function?} sendCowReject https://github.com/dmotz/trystero#sender
 * @property {Function?} sendCowTradeRequest https://github.com/dmotz/trystero#sender
 * @property {Function?} sendPeerMetadata https://github.com/dmotz/trystero#sender
 * @property {boolean} showHomeScreen Option to show the Home Screen
 * @property {boolean} showNotifications
 * @property {farmhand.module:enums.stageFocusType} stageFocus
 * @property {Array.&lt;farmhand.notification>} todaysNotifications
 * @property {number} todaysLosses Should always be a negative number.
 * @property {Object} todaysPurchases Keys are item names, values are their
 * respective quantities.
 * @property {number} todaysRevenue Should always be a positive number.
 * @property {Object} todaysStartingInventory Keys are item names, values are
 * their respective quantities.
 * @property {boolean} useAlternateEndDayButtonPosition Option to display the
 * Bed button on the left side of the screen.
 * @property {Object.&lt;number>} valueAdjustments
 * @property {string} version Comes from the `version` property in
 * package.json.
 */

export default class Farmhand extends Component {
  // Bind event handlers

  localforage = localforage.createInstance({
    name: 'farmhand',
    description: 'Persisted game data for Farmhand',
  })

  /*!
   * @member farmhand.Farmhand#state
   * @type {farmhand.state}
   */
  state = this.createInitialState()

  constructor() {
    super(...arguments)

    this.initInputHandlers()
    this.initReducers()

    // This is antipattern, but it's useful for debugging. The Farmhand
    // component assumes that it is a singleton.
    window.farmhand = this
  }

  getData = getData
  postData = postData

  get viewTitle() {
    return STAGE_TITLE_MAP[this.state.stageFocus]
  }

  get fieldToolInventory() {
    return getFieldToolInventory(this.state.inventory)
  }

  get playerInventory() {
    const { inventory, valueAdjustments } = this.state
    return computePlayerInventory(inventory, valueAdjustments)
  }

  get playerInventoryQuantities() {
    const { inventory } = this.state

    return itemIds.reduce((acc, itemId) => {
      const itemInInventory = inventory.find(({ id }) => id === itemId)
      acc[itemId] = itemInInventory ? itemInInventory.quantity : 0

      return acc
    }, {})
  }

  get plantableCropInventory() {
    return getPlantableCropInventory(this.state.inventory)
  }

  get viewList() {
    const { COW_PEN, FIELD, HOME, WORKSHOP, SHOP } = stageFocusType
    const viewList = [SHOP, FIELD]

    if (this.state.showHomeScreen) {
      viewList.unshift(HOME)
    }

    if (this.state.purchasedCowPen) {
      viewList.push(COW_PEN)
    }

    viewList.push(WORKSHOP)

    return viewList
  }

  get levelEntitlements() {
    return getLevelEntitlements(
      levelAchieved(farmProductsSold(this.state.itemsSold))
    )
  }

  get shopInventory() {
    return getAvailableShopInventory(this.levelEntitlements)
  }

  get peerMetadata() {
    return getPeerMetadata(this.state)
  }

  get isInputBlocked() {
    return (
      this.state.isAwaitingNetworkRequest ||
      this.state.isAwaitingCowTradeRequest ||
      this.state.isWaitingForDayToCompleteIncrementing
    )
  }

  /**
   * @returns {farmhand.state}
   */
  createInitialState() {
    return {
      activePlayers: null,
      allowCustomPeerCowNames: false,
      currentDialogView: dialogView.NONE,
      completedAchievements: {},
      cowForSale: {},
      cowBreedingPen: {
        cowId1: null,
        cowId2: null,
        daysUntilBirth: -1,
      },
      cowColorsPurchased: {},
      cowIdOfferedForTrade: '',
      cowInventory: [],
      cowsSold: {},
      cowsTraded: 0,
      cropsHarvested: {},
      dayCount: 0,
      farmName: 'Unnamed',
      field: createNewField(),
      hasBooted: false,
      heartbeatTimeoutId: null,
      historicalDailyLosses: [],
      historicalDailyRevenue: [],
      historicalValueAdjustments: [],
      hoveredPlotRangeSize: 0,
      id: uuid(),
      inventory: [],
      inventoryLimit: INITIAL_STORAGE_LIMIT,
      isAwaitingCowTradeRequest: false,
      isAwaitingNetworkRequest: false,
      isCombineEnabled: false,
      isMenuOpen: !doesMenuObstructStage(),
      itemsSold: {},
      isDialogViewOpen: false,
      isOnline: this.props.match.path.startsWith('/online'),
      isWaitingForDayToCompleteIncrementing: false,
      learnedRecipes: {},
      loanBalance: STANDARD_LOAN_AMOUNT,
      loansTakenOut: 1,
      money: STANDARD_LOAN_AMOUNT,
      latestNotification: null,
      newDayNotifications: [],
      notificationLog: [],
      peers: {},
      peerRoom: null,
      pendingPeerMessages: [],
      latestPeerMessages: [],
      sendPeerMetadata: null,
      selectedCowId: '',
      selectedItemId: '',
      fieldMode: OBSERVE,
      priceCrashes: {},
      priceSurges: {},
      profitabilityStreak: 0,
      record7dayProfitAverage: 0,
      recordProfitabilityStreak: 0,
      recordSingleDayProfit: 0,
      revenue: 0,
      redirect: '',
      room: decodeURIComponent(this.props.match.params.room || DEFAULT_ROOM),
      purchasedCombine: 0,
      purchasedCowPen: 0,
      purchasedField: 0,
      purchasedSmelter: 0,
      showHomeScreen: true,
      showNotifications: true,
      stageFocus: stageFocusType.HOME,
      todaysNotifications: [],
      todaysLosses: 0,
      todaysPurchases: {},
      todaysRevenue: 0,
      todaysStartingInventory: {},
      toolLevels: {
        [toolType.HOE]: toolLevel.DEFAULT,
        [toolType.SCYTHE]: toolLevel.DEFAULT,
        [toolType.SHOVEL]: toolLevel.UNAVAILABLE,
        [toolType.WATERING_CAN]: toolLevel.DEFAULT,
      },
      useAlternateEndDayButtonPosition: false,
      valueAdjustments: {},
      version: process.env.REACT_APP_VERSION,
    }
  }

  initInputHandlers() {
    const debouncedInputRate = 50

    this.handlers = { debounced: {} }

    Object.keys(eventHandlers).forEach(method => {
      this.handlers[method] = eventHandlers[method].bind(this)

      this.handlers.debounced[method] = debounce(
        this.handlers[method],
        debouncedInputRate
      )
    })

    // NOTE: The dialog view mappings here MUST be kept in sync with the
    // dialogTriggerTextMap map in Navigation.js. They MUST also be kept in
    // sync with the player-facing documentation in KeybindingsView.js
    this.keyMap = {
      incrementDay: 'shift+c',
      nextView: 'right',
      openAccounting: 'b',
      openAchievements: 'a',
      openLog: 'l',
      openPriceEvents: 'e',
      openStats: 's',
      openSettings: ',',
      openKeybindings: 'shift+?',
      previousView: 'left',
      toggleMenu: 'm',
    }

    this.keyHandlers = {
      incrementDay: () => this.incrementDay(),
      nextView: this.focusNextView.bind(this),
      openAccounting: () => this.openDialogView(dialogView.ACCOUNTING),
      openAchievements: () => this.openDialogView(dialogView.ACHIEVEMENTS),
      openLog: () => this.openDialogView(dialogView.FARMERS_LOG),
      openPriceEvents: () => this.openDialogView(dialogView.PRICE_EVENTS),
      openStats: () => this.openDialogView(dialogView.STATS),
      openSettings: () => this.openDialogView(dialogView.SETTINGS),
      openKeybindings: () => this.openDialogView(dialogView.KEYBINDINGS),
      previousView: this.focusPreviousView.bind(this),
      selectHoe: () => this.handlers.handleFieldModeSelect(CLEANUP),
      selectScythe: () => this.handlers.handleFieldModeSelect(HARVEST),
      selectWateringCan: () => this.handlers.handleFieldModeSelect(WATER),
      selectShovel: () => this.handlers.handleFieldModeSelect(MINE),
      toggleMenu: () => this.handlers.handleMenuToggle(),
    }

    nullArray(9).forEach((_, i) => {
      const index = i + 1
      const key = `numberKey${index}`
      this.keyMap[key] = String(index)
      this.keyHandlers[key] = () => {
        const viewName = this.viewList[i]

        if (typeof viewName === 'string') {
          this.setState({ stageFocus: stageFocusType[viewName] })
        }
      }
    })

    if (process.env.NODE_ENV === 'development') {
      Object.assign(this.keyMap, {
        clearPersistedData: 'shift+d',
        waterAllPlots: 'w',
      })
    }

    Object.assign(this.keyHandlers, {
      clearPersistedData: () => this.clearPersistedData(),
      waterAllPlots: () => this.waterAllPlots(this.state),
    })
  }

  initReducers() {
    ;[
      'addCowToInventory',
      'addPeer',
      'adjustLoan',
      'changeCowAutomaticHugState',
      'changeCowBreedingPenResident',
      'changeCowName',
      'clearPlot',
      'computeStateForNextDay',
      'fertilizePlot',
      'forRange',
      'harvestPlot',
      'hugCow',
      'makeRecipe',
      'modifyCow',
      'offerCow',
      'plantInPlot',
      'prependPendingPeerMessage',
      'purchaseCombine',
      'purchaseCow',
      'purchaseCowPen',
      'purchaseField',
      'purchaseItem',
      'purchaseSmelter',
      'purchaseStorageExpansion',
      'removeCowFromInventory',
      'removePeer',
      'selectCow',
      'sellCow',
      'sellItem',
      'setScarecrow',
      'setSprinkler',
      'showNotification',
      'updatePeer',
      'upgradeTool',
      'waterAllPlots',
      'waterField',
      'waterPlot',
      'withdrawCow',
    ].forEach(reducerName => {
      const reducer = reducers[reducerName]

      this[reducerName] = (...args) => {
        this.setState(state => reducer(state, ...args))
      }
    })
  }

  async componentDidMount() {
    const state = await this.localforage.getItem('state')

    if (state) {
      const sanitizedState = transformStateDataForImport({
        ...this.createInitialState(),
        ...state,
      })
      const { isCombineEnabled, newDayNotifications } = sanitizedState

      this.setState({ ...sanitizedState, newDayNotifications: [] }, () => {
        newDayNotifications.forEach(({ message, severity }) => {
          // Defer these notifications so that notistack doesn't swallow all
          // but the last one.
          setTimeout(() => this.showNotification(message, severity), 0)

          if (isCombineEnabled) {
            this.forRange(reducers.harvestPlot, Infinity, 0, 0)
          }
        })
      })
    } else {
      // Initialize new game
      await this.incrementDay(true)
      this.setState(() => ({ historicalValueAdjustments: [] }))
      this.showNotification(LOAN_INCREASED`${STANDARD_LOAN_AMOUNT}`, 'info')
    }

    this.syncToRoom().catch(errorCode => this.handleRoomSyncError(errorCode))

    this.setState({ hasBooted: true, ...this.props.initialState })
  }

  componentDidUpdate(prevProps, prevState) {
    const {
      hasBooted,
      heartbeatTimeoutId,
      isMenuOpen,
      isOnline,
      money,
      peerRoom,
      room,
      stageFocus,
    } = this.state

    // The operations after this if block concern transient gameplay state, but
    // componentDidUpdate runs as part of the rehydration/bootup process. So,
    // check to see if the app has completed booting before doing anything with
    // this transient state.
    if (!hasBooted) {
      return
    }

    const {
      match: {
        path,
        params: { room: newRoom = room },
      },
    } = this.props

    const decodedRoom = decodeURIComponent(newRoom)

    const newIsOnline = path.startsWith('/online')

    if (newIsOnline !== this.state.isOnline || decodedRoom !== room) {
      this.setState(() => ({
        isOnline: newIsOnline,
        redirect: '',
        room: decodedRoom,
      }))
    }

    if (isOnline !== prevState.isOnline || room !== prevState.room) {
      this.syncToRoom().catch(errorCode => this.handleRoomSyncError(errorCode))

      if (!isOnline) {
        clearTimeout(heartbeatTimeoutId)
        this.setState({
          activePlayers: null,
          heartbeatTimeoutId: null,
          peerRoom: null,
        })
      }
    }

    if (isOnline === false &amp;&amp; prevState.isOnline === true) {
      this.showNotification(DISCONNECTED_FROM_SERVER, 'info')
    }

    const updatedAchievementsState = reducers.updateAchievements(
      this.state,
      prevState
    )

    if (updatedAchievementsState !== this.state) {
      this.setState(() => updatedAchievementsState)
    }

    if (
      this.state.stageFocus === stageFocusType.COW_PEN &amp;&amp;
      prevState.stageFocus !== stageFocusType.COW_PEN
    ) {
      this.setState(() => ({ selectedCowId: '' }))
    }

    if (stageFocus !== prevState.stageFocus) {
      if (isMenuOpen) {
        this.setState(() => ({ isMenuOpen: !doesMenuObstructStage() }))
      }
    }

    if (money &lt; prevState.money) {
      this.setState(({ todaysLosses }) => ({
        todaysLosses: moneyTotal(todaysLosses, money - prevState.money),
      }))
    }

    if (peerRoom !== prevState.peerRoom) {
      if (peerRoom) {
        peerRoom.onPeerJoin(id => {
          this.addPeer(id)
        })

        peerRoom.onPeerLeave(id => {
          this.removePeer(id)
        })

        const [sendPeerMetadata, getPeerMetadata] = peerRoom.makeAction(
          'peerMetadata'
        )
        getPeerMetadata((...args) => handlePeerMetadataRequest(this, ...args))

        const [sendCowTradeRequest, getCowTradeRequest] = peerRoom.makeAction(
          'cowTrade'
        )
        getCowTradeRequest((...args) => handleCowTradeRequest(this, ...args))

        const [sendCowAccept, getCowAccept] = peerRoom.makeAction('cowAccept')
        getCowAccept((...args) => handleCowTradeRequestAccept(this, ...args))

        const [sendCowReject, getCowReject] = peerRoom.makeAction('cowReject')
        getCowReject((...args) => handleCowTradeRequestReject(this, ...args))

        this.setState({
          getCowAccept,
          getCowReject,
          getCowTradeRequest,
          getPeerMetadata,
          pendingPeerMessages: [],
          sendCowAccept,
          sendCowReject,
          sendCowTradeRequest,
          sendPeerMetadata: this.wrapSendPeerMetadata(sendPeerMetadata),
        })

        sendPeerMetadata(this.peerMetadata)
      } else {
        // This player has gone offline.
        prevState.peerRoom.leave()
        this.setState({ peers: {}, sendPeerMetadata: null })
      }
    }

    ;[
      'showCowPenPurchasedNotifications',
      'showInventoryFullNotifications',
      'showRecipeLearnedNotifications',
    ].forEach(fn => this[fn](prevState))

    this.state.sendPeerMetadata?.(this.peerMetadata)
  }

  /**
   * @param {Function} sendPeerMetadata Raw send action callback created by
   * Trystero's makeAction function.
   * @return {Function}
   */
  wrapSendPeerMetadata(sendPeerMetadata) {
    return throttle(
      (...args) => {
        sendPeerMetadata(...args)

        this.setState(() => ({
          pendingPeerMessages: [],
        }))
      },
      5000,
      {
        trailing: true,
      }
    )
  }

  /**
   * @param {farmhand.cow} peerPlayerCow
   */
  tradeForPeerCow(peerPlayerCow) {
    this.setState(
      state => {
        const {
          cowIdOfferedForTrade,
          cowInventory,
          peers,
          sendCowTradeRequest,
        } = state

        if (!sendCowTradeRequest) return null

        const { ownerId } = peerPlayerCow

        const [peerId] =
          Object.entries(peers).find(
            ([peerId, peer]) => peer?.id === ownerId
          ) ?? []

        if (!peerId) {
          console.error(
            `Owner not found for cow ${JSON.stringify(peerPlayerCow)}`
          )
          return null
        }

        const playerAlreadyOwnsRequestedCow = cowInventory.find(
          ({ id }) => id === peerPlayerCow.id
        )

        if (playerAlreadyOwnsRequestedCow) {
          console.error(`Cow ID ${peerPlayerCow.id} is already in inventory`)
          return reducers.showNotification(state, COW_ALREADY_OWNED, 'error')
        }

        const cowToTradeAway = cowInventory.find(
          ({ id }) => id === cowIdOfferedForTrade
        )

        if (!cowToTradeAway) {
          console.error(`Cow ID ${cowIdOfferedForTrade} not found`)
          return null
        }

        const cowTradeTimeoutId = setTimeout(
          this.handleCowTradeTimeout,
          COW_TRADE_TIMEOUT
        )

        sendCowTradeRequest(
          {
            cowOffered: { ...cowToTradeAway, isUsingHuggingMachine: false },
            cowRequested: peerPlayerCow,
          },
          peerId
        )

        return { cowTradeTimeoutId, isAwaitingCowTradeRequest: true }
      },
      () => {}
    )
  }

  handleCowTradeTimeout = () => {
    if (typeof this.state.cowTradeTimeoutId === 'number') {
      this.showNotification(REQUESTED_COW_TRADE_UNAVAILABLE, 'error')
      this.setState({
        cowTradeTimeoutId: null,
        isAwaitingCowTradeRequest: false,
      })

      console.error('Cow trade request timed out')
    }
  }

  async clearPersistedData() {
    await this.localforage.clear()

    this.showNotification(DATA_DELETED)
  }

  async syncToRoom() {
    const { isOnline, priceCrashes, priceSurges, room } = this.state

    if (!isOnline) {
      return
    }

    this.showNotification(CONNECTING_TO_SERVER, 'info')

    try {
      this.setState({
        isAwaitingNetworkRequest: true,
        peers: {},
      })

      this.state.peerRoom?.leave()

      const { activePlayers, errorCode, valueAdjustments } = await getData(
        endpoints.getMarketData,
        {
          farmId: this.state.id,
          room: room,
        }
      )

      if (errorCode) {
        // Bail out and move control to this try's catch
        throw new Error(errorCode)
      }

      this.scheduleHeartbeat()

      this.setState({
        activePlayers,
        peerRoom: joinRoom({ appId: process.env.REACT_APP_NAME }, room),
        valueAdjustments: applyPriceEvents(
          valueAdjustments,
          priceCrashes,
          priceSurges
        ),
      })

      this.showNotification(CONNECTED_TO_ROOM`${room}`, 'success')
    } catch (e) {
      // TODO: Add some reasonable fallback behavior in case the server request
      // fails. Possibility: Regenerate valueAdjustments and notify the user
      // they are offline.

      if (SERVER_ERRORS[e.message]) {
        // Bubble up the errorCode to be handled by game logic
        throw e.message
      }

      this.showNotification(SERVER_ERROR, 'error')

      console.error(e)
    }

    this.setState({
      isAwaitingNetworkRequest: false,
      isAwaitingCowTradeRequest: false,
    })
  }

  handleRoomSyncError(errorCode) {
    const { room } = this.state

    switch (errorCode) {
      case SERVER_ERRORS.ROOM_FULL:
        const roomNameChunks = room.split('-')
        const roomNumber = parseInt(roomNameChunks.slice(-1)) // May be NaN
        const nextRoomNumber = isNaN(roomNumber) ? 2 : roomNumber + 1
        const roomBaseName = roomNameChunks
          .slice(0, isNaN(roomNumber) ? undefined : -1)
          .join('-')
        const nextRoom = `${roomBaseName}-${nextRoomNumber}`

        this.showNotification(
          ROOM_FULL_NOTIFICATION`${room}${nextRoom}`,
          'warning'
        )

        this.setState(() => ({
          redirect: `/online/${encodeURIComponent(nextRoom)}`,
        }))

        break

      default:
    }
  }

  scheduleHeartbeat() {
    const { heartbeatTimeoutId, id, room } = this.state
    clearTimeout(heartbeatTimeoutId)

    this.setState(() => ({
      heartbeatTimeoutId: setTimeout(async () => {
        try {
          const { activePlayers, errorCode } = await getData(
            endpoints.getMarketData,
            {
              farmId: id,
              room,
            }
          )

          if (errorCode) {
            // Bail out and move control to this try's catch
            throw new Error(errorCode)
          }

          // If the player has been previously disconnected due to network
          // flakiness (see the catch block below), attempt to rejoin the peer
          // room.
          const peerRoom =
            this.state.peerRoom ||
            joinRoom({ appId: process.env.REACT_APP_NAME }, room)

          this.setState(({ money }) => ({
            activePlayers,
            money: moneyTotal(money, activePlayers),
            peerRoom,
          }))
        } catch (e) {
          if (SERVER_ERRORS[e.message]) {
            // Bubble up the errorCode to be handled by game logic
            throw e.message
          }

          this.showNotification(SERVER_ERROR, 'error')

          this.setState({ peerRoom: null })

          console.error(e)
        }

        this.scheduleHeartbeat()
      }, HEARTBEAT_INTERVAL_PERIOD),
    }))
  }

  /*!
   * @param {farmhand.state} prevState
   */
  showCowPenPurchasedNotifications(prevState) {
    const {
      state: { purchasedCowPen },
    } = this

    if (purchasedCowPen !== prevState.purchasedCowPen) {
      const { cows } = PURCHASEABLE_COW_PENS.get(purchasedCowPen)

      this.showNotification(COW_PEN_PURCHASED`${cows}`)
    }
  }

  /*!
   * @param {farmhand.state} prevState
   */
  showInventoryFullNotifications(prevState) {
    if (
      inventorySpaceRemaining(prevState) > 0 &amp;&amp;
      inventorySpaceRemaining(this.state) &lt;= 0
    ) {
      this.showNotification(INVENTORY_FULL_NOTIFICATION, 'warning')
    }
  }

  /*!
   * @param {farmhand.state} prevState
   */
  showRecipeLearnedNotifications({ learnedRecipes: previousLearnedRecipes }) {
    let learnedRecipes = []

    Object.keys(this.state.learnedRecipes).forEach(recipeId => {
      if (!previousLearnedRecipes.hasOwnProperty(recipeId)) {
        learnedRecipes.push(recipesMap[recipeId])
      }
    })

    if (learnedRecipes.length > 1) {
      this.showNotification(RECIPES_LEARNED`${learnedRecipes}`)
    } else if (learnedRecipes.length === 1) {
      this.showNotification(RECIPE_LEARNED`${learnedRecipes[0]}`)
    }
  }

  /*!
   * @param {Object} [overrides] Data to patch into this.state when persisting.
   * @return {Promise}
   */
  persistState(overrides = {}) {
    return this.localforage.setItem(
      'state',
      reduceByPersistedKeys({
        ...this.state,
        ...overrides,
      })
    )
  }

  /*!
   * @param {boolean} [isFirstDay=false]
   */
  async incrementDay(isFirstDay = false) {
    const {
      inventory,
      isCombineEnabled,
      isOnline,
      room,
      stageFocus,
      todaysPurchases,
      todaysStartingInventory,
    } = this.state
    const nextDayState = reducers.computeStateForNextDay(this.state, isFirstDay)
    const serverMessages = []
    let broadcastedPositionMessage

    if (isOnline) {
      try {
        this.setState({ isAwaitingNetworkRequest: true })

        const positions = computeMarketPositions(
          todaysStartingInventory,
          todaysPurchases,
          inventory
        )

        if (Object.keys(positions).length) {
          serverMessages.push({
            message: POSITIONS_POSTED_NOTIFICATION`${'You'}${positions}`,
            severity: 'info',
          })

          broadcastedPositionMessage = POSITIONS_POSTED_NOTIFICATION`${''}${positions}`
        }

        const { valueAdjustments } = await postData(endpoints.postDayResults, {
          positions,
          room,
        })

        nextDayState.valueAdjustments = applyPriceEvents(
          valueAdjustments,
          nextDayState.priceCrashes,
          nextDayState.priceSurges
        )
      } catch (e) {
        serverMessages.push({
          message: SERVER_ERROR,
          severity: 'error',
        })

        console.error(e)
      }

      this.setState({ isAwaitingNetworkRequest: false })
    }

    const pendingNotifications = [
      ...serverMessages,
      ...nextDayState.newDayNotifications,
    ]

    // This would be cleaner if setState was called after localForage.setItem,
    // but updating the state first makes for a more responsive user
    // experience. The persisted state is computed post-update and stored
    // asynchronously, thus avoiding state changes from being blocked.

    this.setState(
      {
        ...nextDayState,
        isWaitingForDayToCompleteIncrementing: true,
        newDayNotifications: [],
        todaysNotifications: [],
      },
      async () => {
        try {
          await this.persistState({
            // Old pendingNotifications are persisted so that they can be
            // shown to the player when the app reloads.
            newDayNotifications: pendingNotifications,
          })
          ;[]
            .concat(pendingNotifications)
            .concat(
              isFirstDay
                ? []
                : [{ message: PROGRESS_SAVED_MESSAGE, severity: 'info' }]
            )
            .forEach(({ message, severity }) =>
              this.showNotification(message, severity)
            )

          if (isCombineEnabled) {
            if (stageFocus === stageFocusType.FIELD) {
              // Allow the mature crops' animation to complete.
              await sleep(1000)
            }

            this.forRange(reducers.harvestPlot, Infinity, 0, 0)
          }
        } catch (e) {
          console.error(e)

          this.showNotification(JSON.stringify(e), 'error')
        } finally {
          this.setState(() => ({
            isWaitingForDayToCompleteIncrementing: false,
          }))

          if (broadcastedPositionMessage) {
            this.messagePeers(broadcastedPositionMessage)
          }
        }
      }
    )
  }

  /*!
   * @param {farmhand.module:enums.dialogView} dialogView
   */
  openDialogView(dialogView) {
    this.setState({ currentDialogView: dialogView, isDialogViewOpen: true })
  }

  closeDialogView() {
    this.setState({ isDialogViewOpen: false })
  }

  focusNextView() {
    if (document.activeElement.getAttribute('role') === 'tab') return

    const { viewList } = this

    this.setState(({ stageFocus }) => {
      const currentViewIndex = viewList.indexOf(stageFocus)

      return { stageFocus: viewList[(currentViewIndex + 1) % viewList.length] }
    })
  }

  focusPreviousView() {
    if (document.activeElement.getAttribute('role') === 'tab') return

    const { viewList } = this

    this.setState(({ stageFocus }) => {
      const currentViewIndex = viewList.indexOf(stageFocus)

      return {
        stageFocus:
          viewList[
            currentViewIndex === 0
              ? viewList.length - 1
              : (currentViewIndex - 1) % viewList.length
          ],
      }
    })
  }

  /**
   * @param {string} message
   * @param {string?} [severity]
   */
  messagePeers(message, severity) {
    this.prependPendingPeerMessage(message, severity)
  }

  /*!
   * @param {ServiceWorkerRegistration} registration
   */
  showUpdateNotification(registration) {
    // @see https://github.com/jeremyckahn/farmhand/blob/dd1dd502b079be39f50c7d62a54a2027ba83360c/src/service-worker.js#L65-L71
    // @see https://github.com/pwa-builder/pwa-update/blob/1b709e339e1bde6b13cc71eb4812618d2d28fd54/src/pwa-update.ts#L169-L171
    registration.waiting.postMessage({ type: 'SKIP_WAITING' })

    this.showNotification(UPDATE_AVAILABLE, 'success', () => {
      window.location.reload()
    })
  }

  render() {
    const {
      props: { features = {} },
      state: { redirect },
      fieldToolInventory,
      handlers,
      keyHandlers,
      keyMap,
      levelEntitlements,
      plantableCropInventory,
      playerInventory,
      playerInventoryQuantities,
      shopInventory,
      viewList,
      viewTitle,
    } = this

    const blockInput = this.isInputBlocked

    // Bundle up the raw state and the computed state into one object to be
    // passed down through the component tree.
    const gameState = {
      ...this.state,
      blockInput,
      features,
      fieldToolInventory,
      levelEntitlements,
      plantableCropInventory,
      playerInventory,
      playerInventoryQuantities,
      shopInventory,
      viewList,
      viewTitle,
    }

    return (
      &lt;GlobalHotKeys
        {...{
          allowChanges: true,
          keyMap: blockInput ? emptyObject : keyMap,
          handlers: blockInput ? emptyObject : keyHandlers,
        }}
      >
        &lt;MuiThemeProvider theme={theme}>
          &lt;SnackbarProvider
            {...{
              anchorOrigin: { vertical: 'top', horizontal: 'right' },
              classes: {
                containerRoot: 'Farmhand notification-container',
              },
              content: snackbarProviderContentCallback,
              maxSnack: 4,
            }}
          >
            {redirect &amp;&amp; &lt;Redirect {...{ to: redirect }} />}
            &lt;FarmhandContext.Provider value={{ gameState, handlers }}>
              &lt;div
                {...{
                  className: classNames(
                    'Farmhand farmhand-root fill',
                    this.state.isMenuOpen ? 'menu-open' : 'menu-closed',
                    {
                      'use-alternate-end-day-button-position': this.state
                        .useAlternateEndDayButtonPosition,
                      'block-input': blockInput,
                      'has-booted': this.state.hasBooted,
                    }
                  ),
                }}
              >
                &lt;AppBar />
                &lt;Drawer
                  {...{
                    className: 'sidebar-wrapper',
                    open: gameState.isMenuOpen,
                    variant: 'persistent',
                    PaperProps: {
                      className: 'sidebar',
                    },
                  }}
                >
                  &lt;Navigation />
                  &lt;ContextPane />
                  {process.env.NODE_ENV === 'development' &amp;&amp; &lt;DebugMenu />}
                  &lt;div {...{ className: 'spacer' }} />
                &lt;/Drawer>
                &lt;Stage />

                {/*
              These controls need to be at this top level instead of the Stage
              because of scrolling issues in iOS.
              */}
                &lt;div className="bottom-controls">
                  &lt;MobileStepper
                    variant="dots"
                    steps={viewList.length}
                    position="static"
                    activeStep={viewList.indexOf(this.state.stageFocus)}
                    className=""
                  />
                  &lt;div className="fab-buttons buttons">
                    &lt;Fab
                      {...{
                        'aria-label': 'Previous view',
                        color: 'primary',
                        onClick: () => this.focusPreviousView(),
                      }}
                    >
                      &lt;KeyboardArrowLeft />
                    &lt;/Fab>
                    &lt;Fab
                      {...{
                        className: classNames('menu-button', {
                          'is-open': this.state.isMenuOpen,
                        }),
                        color: 'primary',
                        'aria-label': 'Open drawer',
                        onClick: () => handlers.handleMenuToggle(),
                      }}
                    >
                      &lt;MenuIcon />
                    &lt;/Fab>
                    &lt;Fab
                      {...{
                        'aria-label': 'Next view',
                        color: 'primary',
                        onClick: () => this.focusNextView(),
                      }}
                    >
                      &lt;KeyboardArrowRight />
                    &lt;/Fab>
                  &lt;/div>
                &lt;/div>
                &lt;Tooltip
                  {...{
                    placement: 'left',
                    title: (
                      &lt;>
                        &lt;p>
                          End the day to save your progress and advance the
                          game.
                        &lt;/p>
                        &lt;p>(shift + c)&lt;/p>
                      &lt;/>
                    ),
                  }}
                >
                  &lt;Fab
                    {...{
                      'aria-label':
                        'End the day to save your progress and advance the game.',
                      className: 'end-day',
                      color: 'secondary',
                      onClick: handlers.handleClickEndDayButton,
                    }}
                  >
                    &lt;HotelIcon />
                  &lt;/Fab>
                &lt;/Tooltip>
              &lt;/div>
              &lt;NotificationSystem />
            &lt;/FarmhandContext.Provider>
          &lt;/SnackbarProvider>
        &lt;/MuiThemeProvider>
      &lt;/GlobalHotKeys>
    )
  }
}

Farmhand.propTypes = {
  features: object,
  history: object,
  location: object,
  match: object.isRequired,
  initialState: object,
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Tue May 10 2022 14:02:51 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
